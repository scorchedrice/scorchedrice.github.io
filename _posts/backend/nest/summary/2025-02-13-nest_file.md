---
title: "[Nest.js μ •λ¦¬] νμΌ μ—…λ΅λ“ - Multer"
date: 2025-02-13 17:50:00 +0900
categories: [Backend, Nestμ •λ¦¬]
tags: [nest.js, summary, env, path, upload file]
render_with_liquid: false
mermaid: true
---

## π“ Multer

> λ³µμ΅ν• νμΌ μ—…λ΅λ“κ³Όμ •μ„ λ‹¨μν•κ² ν•΄μ£Όλ” μλ°”μ¤ν¬λ¦½νΈμ λΌμ΄λΈλ¬λ¦¬

μ΄λ―Έμ§€λ¥Ό λ„£μ„ μ μλ” κ²μ‹κΈ€ μ‘μ„± κΈ°λ¥μ„ κ°λ°ν•λ‹¤κ³  κ°€μ •ν•κ³  μ§„ν–‰ν•΄λ³΄μ.

### `yarn add`

```shell
yarn add multer @types/multer uuid @types/uuid
```

- μ‚¬μ§„μ„ κ·Έλ€λ΅ μ¬λ¦΄μ μ—†λ‹¤. `uuid`λ¥Ό ν™μ©ν•λ‹¤. 

### Entityμ μμ •

- νμΌμ„ μ¬λ¦¬κΈ° μ ν•©ν•λ„λ΅ μμ •ν•μ.

```ts
// posts/entities/posts.entity.ts
// ...
@Column({
  nullable: true,
})
image?: string;
// ...
```

μ„μ μμ‹μ²λΌ `string`μ„ λ°›λ„λ΅ μ¶”κ°€ν•μ.

### `Multer`μ μ‚¬μ©

`Multer`μ„ μ‚¬μ©ν•κΈ°μ„ν•΄μ„  `~.module.ts`μ— μ΄λ¥Ό λ¶λ¬μ™€μ•Όν•λ‹¤. μ‚¬μ©ν•  λ• λ‹¤μ–‘ν• μµμ…μ΄ μλ”λ°, μ΄λ” κ³µμ‹μλ£λ¥Ό ν™•μΈν•μ.

μ£Όμ” μµμ…μΌλ΅λ” μ‚¬μ΄μ¦μ ν•, νμΌμ–‘μ‹μ ν• λ“±μ΄ μλ‹¤.

```ts
// posts/posts.module.ts
MulterModule.register({
  limits: {
    // λ°”μ΄νΈλ‹¨μ„λ΅ μ‚¬μ΄μ¦ μ ν•
    fileSize: 10000000,
  },
  fileFilter: (req, file, cb) => {
    /**
     * cb(μ—λ¬, boolean)
     *
     * μ²«λ²μ§Έ νλΌλ―Έν„°λ” μ—λ¬κ°€ μμ„κ²½μ° μ—λ¬ μ •λ³΄λ¥Ό λ„£μ–΄μ¤€λ‹¤.
     * λ‘λ²μ§Έ νλΌλ―Έν„°λ” νμΌμ„ λ°›μ„μ§€ λ§μ§€ booleanμ„ λ„£μ–΄μ¤€λ‹¤.
     */

      // pathμ—μ„ extname import ν•μ—¬ μ‚¬μ©
    const ext = extname(file.originalname);
    if (ext !== '.jpg' && ext !== '.jpeg' && ext !== '.png') {
      return cb(
        new BadRequestException(
          'jpg, jpeg, png ν•μ‹μ νμΌλ§ μ—…λ΅λ“ κ°€λ¥ν•©λ‹λ‹¤.',
        ),
        false,
      );
    }
    return cb(null, true);
  },
  storage: multer.diskStorage({
    // νμΌμ„ μ–΄λ””λ΅ λ³΄λ‚ΌκΉ
    destination: function (req, res, cb) {
      cb(null, POST_IMAGE_PATH);
    },
    // νμΌμ„ μ €μ¥ν•  λ• μ–΄λ–¤ μ–‘μ‹μΌλ΅ μ €μ¥ν• κΉ
    filename: function (req, file, cb) {
      cb(null, `${uuid()}${extname(file.originalname)}`);
    },
  }),
}),
```

μ—¬κΈ°μ„ νμΌ κ²½λ΅λ” `path`μ `join`κ³Ό `process`κ°μ²΄μ `cwd()`μΌλ΅ λ¶λ¬μ¨ κ²½λ΅λ¥Ό ν™μ©ν•μ—¬ μ •ν•  μ μλ‹¤.

```ts
// μ„λ²„ ν”„λ΅μ νΈμ λ£¨νΈ ν΄λ”

import { join } from 'path';

// current working directory : cwd
export const PROJECT_ROOT_PATH = process.cwd();

// μ™Έλ¶€μ—μ„ μ ‘κ·Ό κ°€λ¥ν• νμΌλ“¤μ„ λ¨μ•„λ‘” ν΄λ” μ΄λ¦„
export const PUBLIC_FOLDER_NAME = 'public';

// ν¬μ¤νΈ μ΄λ―Έμ§€ μ €μ¥
export const POSTS_FOLDER_NAME = 'posts';

//μ‹¤μ  κ³µκ°ν΄λ”μ μ λ€κ²½λ΅
export const PUBLIC_FOLDER_PATH = join(PROJECT_ROOT_PATH, PUBLIC_FOLDER_NAME);

//ν¬μ¤νΈ μ΄λ―Έμ§€ μ €μ¥ ν΄λ”
export const POST_IMAGE_PATH = join(PUBLIC_FOLDER_PATH, POSTS_FOLDER_NAME);

// /public/posts/xxx.jpg
// {ν”„λ΅μ νΈμ„μΉ}/public/posts
export const POST_PUBLIC_IMAGE_PATH = join(
  PUBLIC_FOLDER_NAME,
  POSTS_FOLDER_NAME,
);
```

## π“ FileInterceptor

μ„μ²λΌ μ„Έν…μ„ λ§μ³¤μΌλ©΄ `controller`μ™€ `service`μ—μ„ νμΌμ„ λ°›μ„ μ μλ„λ΅ ν•΄μ•Όν•λ‹¤. μ΄ λ• `FileInterceptor`μ„ μ‚¬μ©ν•λ‹¤.

```ts
// posts.controller.ts
@Post()
@UseGuards(AccessTokenGuard)
@UseInterceptors(FileInterceptor('image')) // μ΄λ―Έμ§€λ¥Ό μΈν„°μ…‰νΈ, imageλΌλ” ν‚¤κ°’μΌλ¥΄ ν™•μΈν•¨
postPosts(
  // @Request() req : any,
    @User('id') userId: number,
    @Body() body: CreatePostDto,
    @UploadedFile() file?: Express.Multer.File,
) {
    const authorId = userId;
    return this.postsService.createPost(authorId, body, file?.filename);
}
```

```ts
async createPost(authorId: number, postDto: CreatePostDto, image?: string) {
// create => μ €μ¥ν•  κ°μ²΄λ¥Ό μƒμ„±ν•λ‹¤.
// save => κ°μ²΄λ¥Ό μ €μ¥ν•λ‹¤. (create λ§¤μ„λ“μ—μ„ μƒμ„±ν• κ°μ²΄λ΅)
// μ΄λ¥Ό μ΅°ν•©ν•΄μ„ μ§„ν–‰ν•μ!
const post = this.postsRepository.create({
  author: {
    id: authorId,
  },
  ...postDto,
  image: image,
  likeCount: 0,
  commentCount: 0,
});
const newPost = await this.postsRepository.save(post);
return newPost;
```

μ΄ν›„ postmanμ—μ„ μ •μƒμ μΌλ΅ μ—…λ΅λ“ λ¨μ„ ν™•μΈν•  μ μλ‹¤.

<img src="/assets/img/nest/summary/250213/upload_file.png" alt="upload file">

# π’΅κ²°λ΅ 

- `Multer`μ„ ν™μ©ν•μ—¬ νμΌμ„ μ—…λ΅λ“ν•  μ μλ‹¤.
  - `FileInterceptor`μ„ ν™μ©ν•λ‹¤.
- νμΌμ€ `string`ν•μ‹μΌλ΅ λ°›λ”λ‹¤.
- `path`μ—μ„ μ κ³µν•λ” ν•¨μλ΅ κ²½λ΅λ¥Ό μ„¤μ •ν•  μ μλ‹¤.

# π“ Ref

- `μΈν”„λ°` - `μ½”λ“ν©ν† λ¦¬ NestJS`
